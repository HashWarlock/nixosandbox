version: "3.8"

services:
  nixos-sandbox:
    image: nixos/nix:latest
    container_name: nixos-sandbox
    hostname: sandbox
    privileged: true
    security_opt:
      - seccomp:unconfined
      - apparmor:unconfined
    cap_add:
      - SYS_ADMIN
      - NET_ADMIN
    ports:
      - "${SANDBOX_API_PORT:-8080}:8080"      # Control API
      - "${VNC_PORT:-5900}:5900"              # VNC
      - "${NOVNC_PORT:-6080}:6080"            # noVNC web client
      - "${CDP_PORT:-9222}:9222"              # Chrome DevTools Protocol
    volumes:
      - sandbox-app:/app                     # Cloned repo and state
      - sandbox-data:/home/sandbox           # Persistent workspace
      - sandbox-nix:/nix                     # Nix store cache
      - /dev/shm:/dev/shm                    # Shared memory for browser
    environment:
      - PORT=8080
      - DISPLAY=:99
      - HOME=/home/sandbox
      - WORKSPACE=/home/sandbox/workspace
      - SKILLS_DIR=/home/sandbox/skills
      - BROWSER_HEADLESS=${BROWSER_HEADLESS:-true}
      - BROWSER_EXECUTABLE=/nix/var/nix/profiles/default/bin/chromium
      - TZ=${TZ:-UTC}
      - GITHUB_REPO=${GITHUB_REPO:-https://github.com/HashWarlock/nixosandbox.git}
      - GIT_COMMIT_HASH=${GIT_COMMIT_HASH:-HEAD}
      - UPDATE_CODE=${UPDATE_CODE:-false}
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s
    restart: unless-stopped
    command: >
      sh -c "
        mkdir -p /app/.state &&
        if [ ! -f /app/.state/initialized ] || [ \"$$UPDATE_CODE\" = 'true' ]; then
          echo 'Cloning repository...' &&
          rm -rf /app/repo &&
          git clone $$GITHUB_REPO /app/repo &&
          cd /app/repo &&
          git checkout $$GIT_COMMIT_HASH &&
          touch /app/.state/initialized &&
          echo 'Repository cloned and checked out to commit: '$$GIT_COMMIT_HASH;
        else
          echo 'Repository already initialized, skipping clone...';
        fi &&
        cd /app/repo &&
        nix-channel --add https://nixos.org/channels/nixos-24.11 nixpkgs &&
        nix-channel --update &&
        nix-shell /app/repo/nix/shell.nix --run '
          cd /app/repo/sandbox-rs &&
          if [ ! -f target/release/sandbox-api ] || [ \"$$UPDATE_CODE\" = \"true\" ]; then
            echo \"Building Rust API...\" &&
            cargo build --release;
          fi &&
          echo \"Starting sandbox API...\" &&
          ./target/release/sandbox-api
        '
      "

volumes:
  sandbox-app:
    driver: local
  sandbox-data:
    driver: local
  sandbox-nix:
    driver: local

networks:
  default:
    name: sandbox-network
